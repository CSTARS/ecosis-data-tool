<dom-module id="esis-spectra-list">
    <style>
        :host {
            display: block;
            padding: 15px 5px;
        }
    </style>
    <template>

        <div>
            <a class="btn btn-primary" on-click="openFileManager">Open File Manager</a>
            <div class="help-text">Add / Remove spectra and metadata files</div>
        </div>

        <div id="spectra">
            <h4 class="page-header">Spectra</h4>
            <div id="tableRoot"></div>
        </div>

    </template>
</dom-module>

<script>
    Polymer({
        is : 'esis-spectra-list',

        ready : function() {
            this.popup = document.querySelector('esis-popup');
            this.popup.addEventListener('data-update', this.redrawTable.bind(this));
        },

        openFileManager : function() {
            this.popup.show();
        },

        redrawTable : function() {
            var files = Esis.files;

            var table = '<table class="table">'+
                '<tr><th>File</th><th>Spectra</th><th>Attributes</th><th>Score</th><th>Data</th><th></th></tr>';

            var name, score, i, j, className;

            for( i = 0; i < files.length; i++ ) {
                name = files[i].name.replace(/.*\//,'');

                for( j = 0; j < files[i].spectra.length; j++ ) {
                    score = Esis.getSpectraScore(files[i].spectra[j]);
                    className = 'label '+Esis.getScoreClass(score);

                    table += '<tr id="sp-list-'+i+'-'+j+'"><td>'+name+'</td>'+
                             '<td>#'+j+'</td>'+
                             '<td>'+(Object.keys(files[i].spectra[j]).length - 2)+'</td>'+
                             '<td class="score"><label class="label '+className+'">'+score+'/'+Esis.schemaTotal+'</label></td>'+
                             '<td>'+files[i].spectra[j].datapoints.length+'</td>'+
                             '<td><i class="fa fa-edit" spid="'+i+'-'+j+'"></i></td></tr>';
                }
            }

            table = $(table);
            table.find('.fa-edit').on('click', this.showSpectra.bind(this));

            $(this.$.tableRoot).html('').append(table);
        },

        showSpectra : function(e) {
            var parts = e.currentTarget.getAttribute('spid').split('-');
            var fileIndex = parseInt(parts[0]);
            var spectraIndex = parseInt(parts[1]);

            var spectra = Esis.files[fileIndex].spectra[spectraIndex];
            this.fire('show', {
                spectra : spectra,
                fileIndex : fileIndex,
                spectraIndex : spectraIndex
            });
        },

        onSpectraUpdated : function(details) {
            var fileIndex = details.fileIndex;
            var spectraIndex = details.spectraIndex;

            var ele = $('#sp-list-'+fileIndex+'-'+spectraIndex+' .score');

            var score = Esis.getSpectraScore(details.spectra);
            var className = 'label '+Esis.getScoreClass(score);

            ele.html('<label class="label '+className+'">'+score+'/'+Esis.schemaTotal+'</label>');
        }
    })
</script>