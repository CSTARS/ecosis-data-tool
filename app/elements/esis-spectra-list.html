<dom-module id="esis-spectra-list">
    <style>
        :host {
            display: block;
            padding: 15px 5px;
        }
        .fa-edit {
            cursor: pointer;
        }
        .fa-edit:hover {
            color: #df691a;
        }
    </style>
    <template>

        <div>
            <a class="btn btn-primary" on-click="openFileManager">Open File Manager</a>
            <div class="help-text">Add / Remove spectra and metadata files</div>
        </div>

        <div id="spectra">
            <h4 class="page-header">Spectra</h4>
            <div id="tableRoot"></div>
        </div>

    </template>
</dom-module>

<script>
    Polymer({
        is : 'esis-spectra-list',

        ready : function() {
            this.popup = document.querySelector('esis-popup');
            this.popup.addEventListener('data-update', this.redrawTable.bind(this));
        },

        openFileManager : function() {
            this.popup.show();
        },

        redrawTable : function() {
            var files = Esis.files.get();

            var table = '<table class="table table-striped">'+
                '<tr><th></th><th>File</th><th>Spectra</th><th>Attribute Count</th><th>Score</th><th>Data Points</th><th></th></tr>';

            var name, score, i, j, className;

            for( i = 0; i < files.length; i++ ) {
                name = files[i].name.replace(/.*\//,'');


                for( j = 0; j < files[i].sheets.length; j++ ) {
                    var sheet = files[i].sheets[j];
                    if( !sheet.spectra ) continue;

                    for( z = 0; z < sheet.spectra.length; z++ ) {
                        score = Esis.getSpectraScore(sheet.spectra[j]);
                        className = 'label '+Esis.getScoreClass(score);

                        table += '<tr id="sp-list-'+i+'-'+j+'-'+z+'"><td><input type="checkbox" /></td><td>'+name+'</td>'+
                                 '<td>#'+z+'</td>'+
                                 '<td>'+(Object.keys(sheet.spectra[j]).length - 1)+'</td>'+
                                 '<td class="score"><label class="label '+className+'">'+score+'/'+Esis.schemaTotal+'</label></td>'+
                                 '<td>'+sheet.spectra[j].datapoints.length+'</td>'+
                                 '<td><i class="fa fa-edit" style-scope="esis-spectra-list" spid="'+i+'-'+j+'-'+z+'"></i></td></tr>';
                    }
                }
            }

            table = $(table);
            table.find('.fa-edit').on('click', this.showSpectra.bind(this));

            $(this.$.tableRoot).html('').append(table);
        },

        showSpectra : function(e) {
            var id = Esis.parseId(e.currentTarget.getAttribute('spid'));

            var spectra = Esis.getSheet(id[0], id[1]).spectra[id[2]];
            this.fire('show', {
                spectra : spectra,
                id : id
            });
        },

        onSpectraUpdated : function(details) {
            var fileIndex = details.fileIndex;
            var spectraIndex = details.spectraIndex;

            var ele = $('#sp-list-'+fileIndex+'-'+spectraIndex+' .score');

            var score = Esis.getSpectraScore(details.spectra);
            var className = 'label '+Esis.getScoreClass(score);

            ele.html('<label class="label '+className+'">'+score+'/'+Esis.schemaTotal+'</label>');
        }
    })
</script>